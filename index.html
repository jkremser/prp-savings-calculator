import React, { useMemo, useState } from "react";
import { motion } from "framer-motion";
import { Slider } from "@/components/ui/slider";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Info, Server, Wallet, Sparkles, Scissors, ExternalLink } from "lucide-react";

// -------------------------------
// Helper Types & Data
// -------------------------------

type NodeType = {
  name: string;
  vcpu: number;
  memoryGiB: number;
  hourlyUSD: number; // editable by user
};

type Provider = {
  id: "aws" | "gcp" | "azure";
  label: string;
  region: string;
  nodeTypes: NodeType[];
};

const defaultProviders: Provider[] = [
  {
    id: "aws",
    label: "AWS EKS",
    region: "eu-central-1 (Frankfurt)",
    nodeTypes: [
      { name: "m6i.large", vcpu: 2, memoryGiB: 8, hourlyUSD: 0.111 },
      { name: "m6i.xlarge", vcpu: 4, memoryGiB: 16, hourlyUSD: 0.222 },
      { name: "m6i.2xlarge", vcpu: 8, memoryGiB: 32, hourlyUSD: 0.444 },
      { name: "r6i.xlarge", vcpu: 4, memoryGiB: 32, hourlyUSD: 0.302 },
    ],
  },
  {
    id: "gcp",
    label: "Google GKE",
    region: "europe-west1 (Belgium)",
    nodeTypes: [
      { name: "n2-standard-2", vcpu: 2, memoryGiB: 8, hourlyUSD: 0.106 },
      { name: "n2-standard-4", vcpu: 4, memoryGiB: 16, hourlyUSD: 0.214 },
      { name: "n2-standard-8", vcpu: 8, memoryGiB: 32, hourlyUSD: 0.427 },
      { name: "n2-highmem-4", vcpu: 4, memoryGiB: 32, hourlyUSD: 0.287 },
    ],
  },
  {
    id: "azure",
    label: "Azure AKS",
    region: "westeurope (Netherlands)",
    nodeTypes: [
      { name: "D2s_v5", vcpu: 2, memoryGiB: 8, hourlyUSD: 0.096 },
      { name: "D4s_v5", vcpu: 4, memoryGiB: 16, hourlyUSD: 0.192 },
      { name: "D8s_v5", vcpu: 8, memoryGiB: 32, hourlyUSD: 0.384 },
      { name: "E4as_v5", vcpu: 4, memoryGiB: 32, hourlyUSD: 0.248 },
    ],
  },
];

// -------------------------------
// Small utilities
// -------------------------------

function ceilDiv(a: number, b: number) {
  return Math.ceil(a / b);
}

function fmtUSD(n: number) {
  return n.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 4 });
}

// Pack memory using simple first-fit: just divide total by allocatable per node
function packNodes(totalMemGiB: number, nodeMemGiB: number) {
  if (nodeMemGiB <= 0) return Number.POSITIVE_INFINITY;
  return ceilDiv(totalMemGiB, nodeMemGiB);
}

// Given a provider catalog, choose the cheapest node plan to satisfy memory
function bestPlanByMemory(totalMemGiB: number, allocatablePct: number, catalog: NodeType[]) {
  let best = null as null | { node: NodeType; count: number; hourlyCost: number; allocMemPerNode: number };
  for (const n of catalog) {
    const allocPerNode = n.memoryGiB * allocatablePct;
    const count = packNodes(totalMemGiB, allocPerNode);
    const cost = count * n.hourlyUSD;
    if (!best || cost < best.hourlyCost) best = { node: n, count, hourlyCost: cost, allocMemPerNode: allocPerNode };
  }
  return best!;
}

const HOURS_PER_MONTH = 730; // cloud pricing convention (~365*24/12)
const HOURS_PER_YEAR = 8760; // 365*24

export default function App() {
  // Inputs
  const [replicas, setReplicas] = useState(12);
  const [startupGiB, setStartupGiB] = useState(2);
  const [steadyGiB, setSteadyGiB] = useState(0.75);
  const [warmupMin, setWarmupMin] = useState(5);
  const [allocatablePct, setAllocatablePct] = useState(0.85); // allocatable after kube/system overhead

  const [providers, setProviders] = useState<Provider[]>(defaultProviders);

  const totalStartup = useMemo(() => replicas * startupGiB, [replicas, startupGiB]);
  const totalSteady = useMemo(() => replicas * steadyGiB, [replicas, steadyGiB]);

  const results = useMemo(() => {
    return providers.map((p) => {
      const before = bestPlanByMemory(totalStartup, allocatablePct, p.nodeTypes);
      const after = bestPlanByMemory(totalSteady, allocatablePct, p.nodeTypes);
      const warmupFraction = Math.min(Math.max(warmupMin / 60, 0), 1);
      const blended = before.hourlyCost * warmupFraction + after.hourlyCost * (1 - warmupFraction);
      const savingsHourly = before.hourlyCost - blended; // per user's wording: "saving hourly"
      const savingsPct = before.hourlyCost > 0 ? (savingsHourly / before.hourlyCost) * 100 : 0;
      const savingsMonthly = savingsHourly * HOURS_PER_MONTH;
      const savingsYearly = savingsHourly * HOURS_PER_YEAR;
      return { provider: p, before, after, blended, savingsHourly, savingsMonthly, savingsYearly, savingsPct };
    });
  }, [providers, totalStartup, totalSteady, allocatablePct, warmupMin]);

  // Handlers to edit price inline
  const updateNodePrice = (pid: Provider["id"], name: string, price: number) => {
    setProviders((prev) =>
      prev.map((p) =>
        p.id !== pid
          ? p
          : { ...p, nodeTypes: p.nodeTypes.map((n) => (n.name === name ? { ...n, hourlyUSD: price } : n)) }
      )
    );
  };

  const updateNodeMem = (pid: Provider["id"], name: string, mem: number) => {
    setProviders((prev) =>
      prev.map((p) =>
        p.id !== pid
          ? p
          : { ...p, nodeTypes: p.nodeTypes.map((n) => (n.name === name ? { ...n, memoryGiB: mem } : n)) }
      )
    );
  };

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-slate-50 to-white text-slate-900 p-6">
      <div className="max-w-6xl mx-auto space-y-6">
        <header className="flex items-center justify-between gap-4">
          <div className="flex items-center gap-3">
            <img src="/kedify-logo.png" alt="Kedify Logo" className="h-10" />
            <div>
              <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2"><Sparkles className="h-7 w-7"/>Kedify PodResourceProfile Savings Calculator</h1>
              <p className="text-slate-600 mt-1">Estimate cost savings from vertically scaling pods after startup using Kubernetes 1.33+ in‑place resizes, with Karpenter consolidation.</p>
              <div className="flex gap-4 mt-2 text-sm">
                <a href="https://docs.kedify.io/features/pod-resource-profiles/" target="_blank" rel="noopener noreferrer" className="flex items-center gap-1 text-indigo-600 hover:underline">
                  <ExternalLink className="h-3 w-3" />PodResourceProfile Docs
                </a>
                <a href="https://kedify.io/resources/blog/kubernetes-vertical-autoscaling" target="_blank" rel="noopener noreferrer" className="flex items-center gap-1 text-indigo-600 hover:underline">
                  <ExternalLink className="h-3 w-3" />Blog: Kubernetes Vertical Autoscaling
                </a>
              </div>
            </div>
          </div>
        </header>

        {/* Controls */}
        <Card className="shadow-sm rounded-2xl">
          <CardContent className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-5">
              <div>
                <label className="text-sm font-medium flex items-center gap-2"><Server className="h-4 w-4"/>Replicas</label>
                <div className="flex items-center gap-4 mt-2">
                  <Slider value={[replicas]} min={1} max={500} step={1} onValueChange={(v)=>setReplicas(v[0])} className="w-full"/>
                  <Input type="number" className="w-24" value={replicas} onChange={(e)=>setReplicas(parseInt(e.target.value||"0"))}/>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-sm font-medium">Startup memory (GiB)</label>
                  <Input type="number" min={0} step={0.1} value={startupGiB} onChange={(e)=>setStartupGiB(parseFloat(e.target.value||"0"))}/>
                </div>
                <div>
                  <label className="text-sm font-medium">Steady memory (GiB)</label>
                  <Input type="number" min={0} step={0.05} value={steadyGiB} onChange={(e)=>setSteadyGiB(parseFloat(e.target.value||"0"))}/>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-sm font-medium">Warmup duration (minutes)</label>
                  <Input type="number" min={0} step={1} value={warmupMin} onChange={(e)=>setWarmupMin(parseInt(e.target.value||"0"))}/>
                </div>
                <div>
                  <label className="text-sm font-medium">Allocatable fraction</label>
                  <div className="flex items-center gap-2">
                    <Input type="number" min={0.5} max={0.98} step={0.01} value={allocatablePct} onChange={(e)=>setAllocatablePct(parseFloat(e.target.value||"0.85"))}/>
                    <span className="text-sm text-slate-500">(e.g. 0.85 for 15% system overhead)</span>
                  </div>
                </div>
              </div>

              <div className="text-sm text-slate-600 flex items-start gap-2">
                <Info className="h-4 w-4 mt-0.5"/>
                <span>
                  Total startup footprint: <strong>{totalStartup.toFixed(2)} GiB</strong>, steady: <strong>{totalSteady.toFixed(2)} GiB</strong>. Costs blend {warmupMin}m at startup level and the rest at steady level.
                </span>
              </div>
            </div>

            <div className="rounded-xl bg-slate-50 p-4 space-y-3">
              <h3 className="font-semibold">How it works</h3>
              <ul className="list-disc pl-5 text-sm text-slate-600 space-y-2">
                <li>We choose the cheapest node size in each provider catalog that can host your total memory, given <em>allocatable</em> memory per node.</li>
                <li>Before shrink: pack <strong>startup</strong> memory; after shrink: pack <strong>steady</strong> memory. Karpenter consolidation is assumed to remove or replace nodes accordingly.</li>
                <li>Blended hourly cost = (warmup/60) × before + (1 − warmup/60) × after.</li>
                <li>All prices are editable and meant as placeholders. Enter your real blended node price if different (on‑demand, committed use, Spot, etc.).</li>
              </ul>
            </div>
          </CardContent>
        </Card>

        {/* Provider Tabs */}
        <Tabs defaultValue="aws" className="w-full">
          <TabsList className="grid grid-cols-3 w-full max-w-xl">
            <TabsTrigger value="aws">AWS</TabsTrigger>
            <TabsTrigger value="gcp">GCP</TabsTrigger>
            <TabsTrigger value="azure">Azure</TabsTrigger>
          </TabsList>

          {results.map((r) => (
            <TabsContent key={r.provider.id} value={r.provider.id}>
              <ProviderCard
                provider={r.provider}
                before={r.before}
                after={r.after}
                blended={r.blended}
                savingsHourly={r.savingsHourly}
                savingsMonthly={r.savingsMonthly}
                savingsYearly={r.savingsYearly}
                savingsPct={r.savingsPct}
                onEditPrice={updateNodePrice}
                onEditMem={updateNodeMem}
              />
            </TabsContent>
          ))}
        </Tabs>

        <footer className="text-xs text-slate-500">
          <p>Tip: Adjust node prices to your contract (on‑demand, committed use, Savings Plans, Spot). This tool focuses on memory‑driven packing; add CPU constraints by extending the catalog and logic if needed.</p>
        </footer>
      </div>
    </div>
  );
}

function ProviderCard({
  provider,
  before,
  after,
  blended,
  savingsHourly,
  savingsMonthly,
  savingsYearly,
  savingsPct,
  onEditPrice,
  onEditMem,
}: {
  provider: Provider;
  before: { node: NodeType; count: number; hourlyCost: number; allocMemPerNode: number };
  after: { node: NodeType; count: number; hourlyCost: number; allocMemPerNode: number };
  blended: number;
  savingsHourly: number;
  savingsMonthly: number;
  savingsYearly: number;
  savingsPct: number;
  onEditPrice: (pid: Provider["id"], name: string, price: number) => void;
  onEditMem: (pid: Provider["id"], name: string, mem: number) => void;
}) {
  const savingColor = savingsHourly >= 0 ? "text-emerald-600" : "text-rose-600";
  return (
    <Card className="shadow-sm rounded-2xl">
      <CardContent className="p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h3 className="text-xl font-semibold flex items-center gap-2"><Scissors className="h-5 w-5"/> {provider.label} <span className="text-slate-500 text-sm">— {provider.region}</span></h3>
          </div>
          <div className="text-right">
            <div className="text-sm text-slate-600">Saving hourly</div>
            <div className={`text-2xl font-bold ${savingColor}`}>{fmtUSD(savingsHourly)}</div>
            <div className="text-sm text-slate-600 mt-2">Saving monthly</div>
            <div className={`text-lg font-semibold ${savingColor}`}>{fmtUSD(savingsMonthly)}</div>
            <div className="text-sm text-slate-600 mt-2">Saving yearly</div>
            <div className={`text-lg font-semibold ${savingColor}`}>{fmtUSD(savingsYearly)}</div>
            <div className={`text-sm mt-2 ${savingColor}`}>{savingsHourly >= 0 ? "Savings" : "Increase"}: {savingsPct.toFixed(1)}%</div>
          </div>
        </div>

        <div className="grid md:grid-cols-2 gap-4">
          <PlanPanel title="Before shrink (startup)" plan={before} accent="before" />
          <PlanPanel title="After shrink (steady)" plan={after} accent="after" />
        </div>

        <div className="rounded-xl border p-4">
          <h4 className="font-medium mb-3">Node catalog (edit prices or memory if needed)</h4>
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
            {provider.nodeTypes.map((n) => (
              <div key={n.name} className="rounded-xl bg-slate-50 p-3 space-y-2">
                <div className="font-medium">{n.name}</div>
                <div className="text-sm text-slate-600">{n.vcpu} vCPU • {n.memoryGiB} GiB RAM</div>
                <div className="flex items-center gap-2 text-sm">
                  <span className="text-slate-500">$/h</span>
                  <Input type="number" step={0.001} value={n.hourlyUSD}
                    onChange={(e)=>onEditPrice(provider.id, n.name, parseFloat(e.target.value||"0"))}/>
                </div>
                <div className="flex items-center gap-2 text-sm">
                  <span className="text-slate-500">Mem (GiB)</span>
                  <Input type="number" step={0.5} value={n.memoryGiB}
                    onChange={(e)=>onEditMem(provider.id, n.name, parseFloat(e.target.value||"0"))}/>
                </div>
              </div>
            ))}
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

function PlanPanel({ title, plan, accent }: { title: string; plan: { node: NodeType; count: number; hourlyCost: number; allocMemPerNode: number }; accent: "before"|"after" }) {
  return (
    <div className="rounded-xl border p-4">
      <div className="flex items-center justify-between mb-2">
        <div className="font-medium">{title}</div>
        <div className="text-sm text-slate-600 flex items-center gap-1"><Wallet className="h-4 w-4"/> {fmtUSD(plan.hourlyCost)}/h</div>
      </div>
      <div className="grid grid-cols-2 gap-2 text-sm">
        <div className="rounded-lg bg-slate-50 p-3">
          <div className="text-slate-500">Recommended nodes</div>
          <div className="font-semibold">{plan.count} × {plan.node.name}</div>
        </div>
        <div className="rounded-lg bg-slate-50 p-3">
          <div className="text-slate-500">Allocatable per node</div>
          <div className="font-semibold">{plan.allocMemPerNode.toFixed(1)} GiB</div>
        </div>
      </div>
      <div className="text-xs text-slate-500 mt-2">We choose the cheapest option from the catalog by memory packing (simple division). For fine control, edit the catalog or add series you actually allow in NodePools.</div>
    </div>
  );
}
